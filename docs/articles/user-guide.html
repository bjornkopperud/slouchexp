<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Slouch user guide • slouch</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">slouch</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://github.com/kopperud/slouch">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Slouch user guide</h1>
                        <h4 class="author">Bjørn Tore Kopperud</h4>
            
            <h4 class="date">2017-05-05</h4>
          </div>

    
    
<div class="contents">
<p>Slouch is an implementation of a particular phylogenetic comparative method. It can fit univariate among-species Ornstein-Uhlenbeck models of phenotypic trait evolution, where the trait evolves toward a primary optimum. Optima can be fitted either as discrete regimes as niches on the phylogenetic tree, and/or with continuous covariates. See the following articles for more information about the theoretical background, how the method is derived, and how to interpret the parameters.</p>
<ul>
<li>Hansen (1997)<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>
</li>
<li>Butler &amp; King (2004)<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a>
</li>
<li>Hansen <em>et al.</em> (2008)<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a>
</li>
<li>Labra <em>et al.</em> (2009)<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a>
</li>
<li>Hansen &amp; Bartoszek (2012)<a href="#fn5" class="footnoteRef" id="fnref5"><sup>5</sup></a>
</li>
</ul>
<div id="prerequisites" class="section level2">
<h2 class="hasAnchor">
<a href="#prerequisites" class="anchor"></a>Prerequisites</h2>
<p>In order to fit an Ornstein-Uhlenbeck model in slouch, you will need to have a phylogenetic tree of interest in the <code>phylo</code> format, from package <code>ape</code>. The phylogenetic tree must be rooted. Polytomies and non-branching edges are allowed. Both ultrametric and non-ultrametric trees can be used, but this will have implications for what parameters can reliably be estimated. For the purposes of illustrating syntax, let’s create an arbitrary tree.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ape)

<span class="kw">set.seed</span>(<span class="dv">8</span>)
n &lt;-<span class="st"> </span><span class="dv">80</span>
phy &lt;-<span class="st"> </span><span class="kw">rtree</span>(n)

oldmar &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="st">"mar"</span>); <span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))
<span class="kw">plot</span>(<span class="kw">ladderize</span>(phy))</code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-1-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">par</span>(<span class="dt">mar =</span> oldmar)</code></pre></div>
<p>Slouch can fit univariate Ornstein-Uhlenbeck models. Let’s create a toy dataset. The species in the data frame need to be in a particular order to line up with the order of the tree, so I will intentionally scramble the dataframe first, to illustrate how to reorder it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mydata &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">species =</span> phy$tip.label,
                     <span class="dt">y =</span> <span class="kw">rnorm</span>(n, <span class="dt">sd =</span> <span class="dv">4</span>) +<span class="st"> </span><span class="dv">1</span>:n*<span class="fl">1.7</span>,
                     <span class="dt">x =</span> <span class="kw">rnorm</span>(n, <span class="dt">sd =</span> <span class="dv">4</span>) +<span class="st"> </span><span class="dv">1</span>:n,
                     <span class="dt">z =</span> <span class="kw">rnorm</span>(n, <span class="dt">sd =</span> <span class="dv">4</span>) +<span class="st"> </span><span class="dv">1</span>:n*(-<span class="fl">0.6</span>))

<span class="kw">plot</span>(mydata$x, mydata$y, <span class="dt">ylab =</span> <span class="st">"y"</span>, <span class="dt">xlab =</span> <span class="st">"x"</span>)</code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Scramble the rows
mydata &lt;-<span class="st"> </span>mydata[<span class="kw">sample</span>(<span class="dv">1</span>:n, n),]

## Check whether they are lined up correctly
mydata$species ==<span class="st"> </span>phy$tip.label</code></pre></div>
<pre><code>##  [1] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [12] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [23] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [34] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [45] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [56] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [67] FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
## [78] FALSE FALSE FALSE</code></pre>
<p>Unsurprisingly, not a single one of the species is in its correct place. As <code>slouch</code> is (for now) intentionally programmed in a <em>dumb</em> way, we will have to reorder the species. Here is one way to do it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mydata &lt;-<span class="st"> </span>mydata[<span class="kw">match</span>(phy$tip.label, mydata$species) ,]

## Check if they line up again
mydata$species ==<span class="st"> </span>phy$tip.label</code></pre></div>
<pre><code>##  [1] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
## [15] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
## [29] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
## [43] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
## [57] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE
## [71] TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE TRUE</code></pre>
</div>
<div id="single-optimum-model" class="section level2">
<h2 class="hasAnchor">
<a href="#single-optimum-model" class="anchor"></a>Single optimum model</h2>
<p>Now we are ready to fit the first models, for which we will use the function <code>slouch.fit</code>. The following is an intercept only model, or a single optimum model. In <code>slouch</code>, there are two main techniques for estimating the most likely <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\sigma_y^2\)</span> parameters. In this particular implementation the <span class="math inline">\(\sigma_y^2\)</span> is reparameterized as <span class="math inline">\(\frac{\sigma_y^2}{2\alpha}\)</span>, which is the variance of the predictor variable when it is stationary around the optimum. The first way is to use a grid-search of likely parameters from user input, which may take some trial and error.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(slouch)
model0 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/slouch.fit.html">slouch.fit</a></span>(<span class="dt">phy =</span> phy,
                     <span class="dt">hl_values =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dt">length.out =</span> <span class="dv">10</span>),
                     <span class="dt">vy_values =</span> <span class="kw">seq</span>(<span class="dv">150</span>, <span class="dv">800</span>, <span class="dt">length.out =</span> <span class="dv">10</span>),
                     <span class="dt">species =</span> mydata$species,
                     <span class="dt">response =</span> mydata$y)
<span class="kw">plot</span>(model0, <span class="dt">cex.lab =</span> <span class="fl">0.7</span>, <span class="dt">cex.axis =</span> <span class="fl">0.7</span>)

model0 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/slouch.fit.html">slouch.fit</a></span>(<span class="dt">phy =</span> phy,
                     <span class="dt">hl_values =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">100</span>, <span class="dt">length.out =</span> <span class="dv">25</span>),
                     <span class="dt">vy_values =</span> <span class="kw">seq</span>(<span class="fl">0.1</span>, <span class="dv">10000</span>, <span class="dt">length.out =</span> <span class="dv">25</span>),
                     <span class="dt">species =</span> mydata$species,
                     <span class="dt">response =</span> mydata$y)
<span class="kw">plot</span>(model0, <span class="dt">cex.lab =</span> <span class="fl">0.7</span>, <span class="dt">cex.axis =</span> <span class="fl">0.7</span>)</code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-4-1.png" width="288"><img src="user-guide_files/figure-html/unnamed-chunk-4-2.png" width="288"></p>
<p>These plots of the likelihood surfaces are both based on the same data, but with different grid location and resolution. The optima and model fit statistics that are reported in the output are conditional on a particular combination of these <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\sigma_y^2/2\alpha\)</span>. When the grid-search is used, these parameters are the combination which gives the highest log-likelihood; the peak of the surface in the likelihood plot. If the grid-search does not contain the true maximum likelihood, the model outputs will reflect this.</p>
<p>It is also possible to use other packages to plot the grid-search likelihood surface, for a more fancy look (not run).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(plotly)
p &lt;-<span class="st"> </span><span class="kw">plot_ly</span>(<span class="dt">x =</span> model0$supportplot$hl,
             <span class="dt">y =</span> model0$supportplot$vy,
             <span class="dt">z =</span> model0$supportplot$z) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">add_surface</span>() %&gt;%
<span class="st">  </span><span class="kw">layout</span>(<span class="dt">title =</span> <span class="st">"Grid-search"</span>,
         <span class="dt">scene =</span> <span class="kw">list</span>(<span class="dt">xaxis =</span> <span class="kw">list</span>(<span class="dt">title =</span> <span class="st">"Phylogenetic half-life"</span>), 
                      <span class="dt">yaxis =</span> <span class="kw">list</span>(<span class="dt">title =</span> <span class="st">"Stationary variance"</span>),
                      <span class="dt">zaxis =</span> <span class="kw">list</span>(<span class="dt">title =</span> <span class="st">"Log-likelihood"</span>)))

p</code></pre></div>
<p>Another, perhaps more convenient way of estimating parameters is to use the hillclimber function. On default it will start on a random combination of <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\sigma_y^2/2\alpha\)</span>, but this may also be specified. While the hillclimber might seem both faster and more accurate at first glance, there are some drawbacks. If the likelihood search space has one or more local maxima, the hillclimber may converge at a sub-optimal location and give parameter estimates which are not truly maximum likelihood estimates.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model0 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/slouch.fit.html">slouch.fit</a></span>(<span class="dt">phy =</span> phy,
                     <span class="dt">species =</span> mydata$species,
                     <span class="dt">response =</span> mydata$y,
                     <span class="dt">hillclimb =</span> <span class="ot">TRUE</span>)
<span class="kw">plot</span>(model0)</code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-5-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model0$oupar</code></pre></div>
<pre><code>##                                    Estimate
## Rate of adaptation             9.672302e-08
## Phylogenetic half-life         7.166310e+06
## Stationary variance            6.788459e+08
## Phylogenetic correction factor 1.908297e-07</code></pre>
<p>In this case, the ML estimate of the phylogenetic half-life <span class="math inline">\(t_{1/2} = log(2)/\alpha\)</span> was very large. The units of the phylogenetic half-life are the same units as the branch lengths in the phylogenetic tree, <code>phy$edge.length</code>. The total depth, or distance from the root, can for all nodes be calculated with <code>node.depth.edgelength(phy)</code>. In this case the maximum depth is about 6.65. Given that the estimated half-life <span class="math inline">\(t_{1/2}\)</span> was many times larger than the total length of the phylogeny, and that <span class="math inline">\(\alpha\)</span> is very close to zero, we can say that there is next to no strength of pull toward the optimum. If there is no such pull, the model collapses to a Brownian motion.</p>
</div>
<div id="optima-as-a-linear-regression" class="section level2">
<h2 class="hasAnchor">
<a href="#optima-as-a-linear-regression" class="anchor"></a>Optima as a linear regression</h2>
<p>Slouch can also fit continuous covariates to the model, with the optimum being a linear regression. The covariates may either be fitted as direct effects without a phylogenetic covariance structure, or as univariate Brownian motion variables. Let’s fit our toy x as a direct effect. One problem with fitting direct effect covariate models is that its residual variance-covariance matrix collapses if <span class="math inline">\(\sigma_y^2/2\alpha\)</span> reaches zero. The immediate consequence is that the residual variance-covariance matrix <span class="math inline">\(V\)</span> is non-invertible, and the program will crash. If within-species observational error is added to the model, this does not happen. In order to use the hillclimber in this scenario, it may be necessary to constrain its search space such that it does not enter zero or close to zero. The exact feasible boundary for this may depend on the scale of the response trait.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/slouch.fit.html">slouch.fit</a></span>(<span class="dt">phy =</span> phy,
                     <span class="dt">species =</span> mydata$species,
                     <span class="dt">response =</span> mydata$y,
                     <span class="dt">fixed.cov =</span> mydata$x,
                     <span class="dt">lower =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.01</span>),
                     <span class="dt">hillclimb =</span> <span class="ot">TRUE</span>)
<span class="kw">plot</span>(model1)

<span class="kw">plot</span>(mydata$x, mydata$y, <span class="dt">ylab =</span> <span class="st">"y"</span>, <span class="dt">xlab =</span> <span class="st">"x"</span>, <span class="dt">main =</span> <span class="st">"Trait plot"</span>)
<span class="kw">abline</span>(<span class="kw">lm</span>(mydata$y ~<span class="st"> </span>mydata$x), <span class="dt">col =</span> <span class="st">"black"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)
<span class="kw">abline</span>(model1$opt.reg$coefficients[,<span class="dv">1</span>], <span class="dt">col =</span> <span class="st">"orange"</span>, <span class="dt">lwd =</span> <span class="dv">2</span>)
model1$opt.reg$coefficients</code></pre></div>
<pre><code>##           Estimates Std. error
## Intercept  1.869318  1.6161664
## mydata$x   1.646679  0.0340688</code></pre>
<p><img src="user-guide_files/figure-html/unnamed-chunk-6-1.png" width="672"><img src="user-guide_files/figure-html/unnamed-chunk-6-2.png" width="672"></p>
<p>Even though the single-optimum model showed considerable phylogenetic inertia, in this model it has completely vanished. In this case, the regression line estimated using ordinary least squares is indistinguishable from the Ornstein-Uhlenbeck optimal regression. Given that we started with random normally distributed variables without any phylogenetic correlation structure, this makes sense. It is also possible to fit a model with multiple continuous covariates, however the input to <code>fixed.cov</code> must be a matrix that has column names.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model2 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/slouch.fit.html">slouch.fit</a></span>(<span class="dt">phy =</span> phy,
                     <span class="dt">species =</span> mydata$species,
                     <span class="dt">response =</span> mydata$y,
                     <span class="dt">fixed.cov =</span> <span class="kw">cbind</span>(<span class="dt">x =</span> mydata$x, <span class="dt">z =</span> mydata$z),
                     <span class="dt">lower =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.01</span>),
                     <span class="dt">hillclimb =</span> <span class="ot">TRUE</span>)
<span class="kw">plot</span>(model2)</code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
</div>
<div id="multiple-optima-phylo-format" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-optima-phylo-format" class="anchor"></a>Multiple optima &amp; phylo-format</h2>
<p>Slouch can fit multiple optima modeled as adaptive regimes or niches over the the branches of the phylogenetic tree. Let’s create another toy variable with some arbitrary adaptive regimes for the tips in the tree.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">categories &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>)
mydata$category &lt;-<span class="st"> </span><span class="kw">sample</span>(categories, n, <span class="dt">replace =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p>Next, we need to specify the adaptive regime for each internal node in the tree. Trees in the<code>phylo</code> format are represented by the edges found in <code>phy$edge</code>, where each edge connects two vertices or nodes. All of the tip nodes have indices starting from 1, 2, 3, 4 … until <span class="math inline">\(n_{tips}\)</span>, in this case 80. The root node has index <span class="math inline">\(n_{tips}\)</span>+1, here 81, and the rest of the internal nodes have indices (<span class="math inline">\(n_{tips}\)</span>+2, <span class="math inline">\(n_{tips}\)</span>+3, <span class="math inline">\(n_{tips}\)</span>+4, …, <span class="math inline">\(n_{nodes}\)</span>). When running this type of model in slouch, you will need to specify the internal adaptive regimes in the order of node indices (<span class="math inline">\(n_{tips}\)</span>+1, <span class="math inline">\(n_{tips}\)</span>+2, <span class="math inline">\(n_{tips}\)</span>+3, <span class="math inline">\(n_{tips}\)</span>+4, …, <span class="math inline">\(n_{nodes}\)</span>).</p>
<p>The adaptive regimes are part of an a priori hypothesis of the trait evolution. Here we will reconstruct the ancestral states using <code>ape</code>. In order to plot and visually verify that the reconstruction is sensible, we need to have all the regimes in the order of the <strong>edges</strong>, not the nodes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ape)
reconstruction &lt;-<span class="st"> </span><span class="kw">ace</span>(mydata$category, phy, <span class="dt">type =</span> <span class="st">"d"</span>)

## Extract the most likely regime for each internal node
## These have order n+1, n+2, n+3 ...
internal_regimes &lt;-<span class="st"> </span><span class="kw">apply</span>(reconstruction$lik.anc, 
                          <span class="dv">1</span>, 
                          function(e) <span class="kw">colnames</span>(reconstruction$lik.anc)[<span class="kw">which.max</span>(e)])

## Concatenate tip and internal regimes. These will have order 1,2,3,4, ...
regimes &lt;-<span class="st"> </span><span class="kw">c</span>(mydata$category, internal_regimes)

## Pick out the regimes of the edges, in the order of phy$edge
edge_regimes &lt;-<span class="st"> </span><span class="kw">factor</span>(regimes[phy$edge[,<span class="dv">2</span>]])

oldmar &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="st">"mar"</span>); <span class="kw">par</span>(<span class="dt">mar =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))
<span class="kw">plot</span>(phy, <span class="dt">edge.color =</span> <span class="kw">c</span>(<span class="st">"Black"</span>, <span class="st">"#EE7600"</span>, <span class="st">"blue"</span>)[edge_regimes], <span class="dt">edge.width =</span> <span class="dv">3</span>)</code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">par &lt;-<span class="st"> </span><span class="kw">par</span>(oldmar)</code></pre></div>
<p>If it looks like are no obvious mistakes, we can go ahead and fit the slouch model.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">phy$node.label &lt;-<span class="st"> </span>internal_regimes

model3 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/slouch.fit.html">slouch.fit</a></span>(<span class="dt">phy =</span> phy,
                     <span class="dt">species =</span> mydata$species,
                     <span class="dt">response =</span> mydata$y,
                     <span class="dt">fixed.cov =</span> mydata$x,
                     <span class="dt">fixed.fact =</span> mydata$category,
                     <span class="dt">hillclimb =</span> <span class="ot">TRUE</span>,
                     <span class="dt">lower =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.01</span>))

model3$opt.reg$coefficients</code></pre></div>
<pre><code>##          Estimates Std. error
## A        0.2268974  2.1965285
## B        2.2792540  1.8366296
## C        1.6091706  1.9139240
## mydata$x 1.6537541  0.0339626</code></pre>
</div>
<div id="randomly-evolving-environment" class="section level2">
<h2 class="hasAnchor">
<a href="#randomly-evolving-environment" class="anchor"></a>Randomly evolving environment</h2>
<p>Slouch can also fit models with continuous covariates that themselves have a phylogenetic covariance structure. Currently the only option is to model them as univariate Brownian motions. If <span class="math inline">\(\alpha &gt; 0\)</span>, the optimal regression and the evolutionary regression will differ. Here, both the grid-search and the hillclimber routine are used to find the ML estimates for <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\frac{\sigma_y^2}{2\alpha}\)</span>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">phy$node.label &lt;-<span class="st"> </span>internal_regimes

model4 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/slouch.fit.html">slouch.fit</a></span>(<span class="dt">phy =</span> phy,
                     <span class="dt">hl_values =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="fl">0.25</span>, <span class="dt">length.out =</span> <span class="dv">25</span>),
                     <span class="dt">vy_values =</span> <span class="kw">seq</span>(<span class="dv">20</span>, <span class="dv">60</span>, <span class="dt">length.out =</span> <span class="dv">25</span>),
                     <span class="dt">species =</span> mydata$species,
                     <span class="dt">response =</span> mydata$y,
                     <span class="dt">fixed.cov =</span> mydata$x,
                     <span class="dt">random.cov =</span> mydata$z,
                     <span class="dt">fixed.fact =</span> mydata$category,
                     <span class="dt">hillclimb =</span> <span class="ot">TRUE</span>,
                     <span class="dt">lower =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>))

<span class="kw">plot</span>(model4)</code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model4$opt.reg$coefficients</code></pre></div>
<pre><code>##           Estimates Std. error
## A        -1.4082354  2.0118660
## B         1.5046738  1.6621227
## C         1.1337499  1.7255553
## mydata$x  1.3008177  0.0867812
## mydata$z -0.6309597  0.1452057</code></pre>
</div>
<div id="observational-error" class="section level2">
<h2 class="hasAnchor">
<a href="#observational-error" class="anchor"></a>Observational error</h2>
<p>The variables that we study are seldom estimated without error. Slouch can incorporate this by specifying the within-species estimation variances. For example, if <span class="math inline">\(X\)</span> is the mean body mass for each species, the statistic for the measurement error argument would be the variance of the mean for each species.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">phy$node.label &lt;-<span class="st"> </span>internal_regimes

model5 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/slouch.fit.html">slouch.fit</a></span>(<span class="dt">phy =</span> phy,
                     <span class="dt">hl_values =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="fl">0.25</span>, <span class="dt">length.out =</span> <span class="dv">25</span>),
                     <span class="dt">vy_values =</span> <span class="kw">seq</span>(<span class="dv">20</span>, <span class="dv">60</span>, <span class="dt">length.out =</span> <span class="dv">25</span>),
                     <span class="dt">species =</span> mydata$species,
                     <span class="dt">response =</span> mydata$y,
                     <span class="dt">me.response =</span> <span class="fl">0.01</span>*<span class="kw">rnorm</span>(n),
                     <span class="dt">fixed.cov =</span> mydata$x,
                     <span class="dt">me.fixed.cov =</span> <span class="fl">0.01</span>*<span class="kw">rnorm</span>(n),
                     <span class="dt">random.cov =</span> mydata$z,
                     <span class="dt">me.random.cov =</span> <span class="fl">0.01</span>*<span class="kw">rnorm</span>(n),
                     <span class="dt">hillclimb =</span> <span class="ot">TRUE</span>,
                     <span class="dt">lower =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>))

<span class="kw">plot</span>(model5)</code></pre></div>
<p><img src="user-guide_files/figure-html/unnamed-chunk-12-1.png" width="672"></p>
<p>The generalized least squares (GLS) estimator will calculate a more shallow regression line when measurement error is incorporated. A bias-correction for these regression coefficients is implemented, but keep in mind all of the reported model fit statistics are conditional on the <em>naive</em> optimal regression. See Hansen &amp; Bartoszek (2012) for further reading.</p>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Hansen, T. F. (1997). Stabilizing Selection and the Comparative Analysis of Adaptation. Evolution, 51(5), 1341. <a href="https://doi.org/10.2307/2411186" class="uri">https://doi.org/10.2307/2411186</a><a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>Butler, M. A., &amp; King, A. A. (2004). Phylogenetic comparative analysis: a modeling approach for adaptive evolution. American Naturalist, 164(6), 683–695. <a href="https://doi.org/10.1086/426002" class="uri">https://doi.org/10.1086/426002</a><a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>Hansen, T. F., Pienaar, J., &amp; Orzack, S. H. (2008). A comparative method for studying adaptation to a randomly evolving environment. Evolution, 62(8), 1965–1977. <a href="https://doi.org/10.1111/j.1558-5646.2008.00412.x" class="uri">https://doi.org/10.1111/j.1558-5646.2008.00412.x</a><a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>Labra, A., Pienaar, J., &amp; Hansen, T. F. (2009). Evolution of Thermal Physiology in Liolaemus Lizards: Adaptation, Phylogenetic Inertia, and Niche Tracking. The American Naturalist, 174(2), 204–220. <a href="https://doi.org/10.1086/600088" class="uri">https://doi.org/10.1086/600088</a><a href="#fnref4">↩</a></p></li>
<li id="fn5"><p>Hansen, T. F., &amp; Bartoszek, K. (2012). Interpreting the evolutionary regression: The interplay between observational and biological errors in phylogenetic comparative studies. Systematic Biology, 61(3), 413–425. <a href="https://doi.org/10.1093/sysbio/syr122" class="uri">https://doi.org/10.1093/sysbio/syr122</a><a href="#fnref5">↩</a></p></li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#prerequisites">Prerequisites</a></li>
      <li><a href="#single-optimum-model">Single optimum model</a></li>
      <li><a href="#optima-as-a-linear-regression">Optima as a linear regression</a></li>
      <li><a href="#multiple-optima-phylo-format">Multiple optima &amp; phylo-format</a></li>
      <li><a href="#randomly-evolving-environment">Randomly evolving environment</a></li>
      <li><a href="#observational-error">Observational error</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Bjørn Tore Kopperud, Jason Pienaar, Kjetil Lysne Voje.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
